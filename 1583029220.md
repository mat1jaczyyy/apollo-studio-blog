# Apollo Studio Progress Report: December 2019, January and February 2020

The bridge towards the new year marks a stale period for the development of Apollo Studio. Most improvements were either quality of life features or performance optimizations, but there were some new highly requested devices sprinkled in as well! Today we won't be putting much focus on that though, we're going to be talking more about the situation with modern Launchpads as well as the future of Apollo Studio.

Since the last progress report, we've updated from version [1.3.0](https://github.com/mat1jaczyyy/apollo-studio/releases/tag/1.3.0) to version [1.4.1](https://github.com/mat1jaczyyy/apollo-studio/releases/tag/1.4.1).

## Launchpad X Layout problem

Continuing the Launchpad X saga, last blog post we talked about some questionable decisions regarding the SysEx API and color format found on the Launchpad X. Since the initial first look, we've learned a lot about how the Launchpads work internally and how to better understand them, leading to a lot of realizations. One of those being that, the color on the LEDs is in fact of 6-bit resolution (the 8-bit palette gets crushed down to 6 bits per color channel when drawing on the LEDs). A bummer, but means we've gotten it right and don't need to change Apollo's color system yet again.

About the elephant in the room (that we've been mostly ignoring thus far, primarily because it's not of Apollo Studio's concern), we briefly mentioned in an earlier report that the Launchpad X can only be used in Ableton Live and other DAWs in Programmer mode when considering a "cover"-like set. The largest disadvantage there is being forced to either use the XY Layout (which Apollo has supported since the beginning, even before the new Launchpads were released) or use a bunch of Max for Live devices in each project to maintain backwards compatibility with the decade-old standard Drum Rack layout.

Personally for us it was sad to see this being the only workaround to the problem, as in part the patches can cause issues with the Apollo Connector. We set out on a mission to solve this problem at its core, by changing the layout of the pads on the Launchpad firmware itself. We knew it was not going to be an easy task, but seeing as Novation wasn't showing much enthusiasm towards fixing the problem, we felt it was our duty as the Apollo Studio team to resolve the matter.

The entire project was managed by a team of three people: Brendonovich, mat1jaczyyy and vaaski. You've heard of Brendonovich from the last entry in the series, but you might not be keen on vaaski's backstory. vaaski is a retired launchpadder who used to practice it as a minor hobby multiple years ago, who I've kept in touch with throughout the years. They specialize in web development, and we've built lots of things together already. My [personal homepage](https://mat1jaczyyy.com) and the Apollo Studio website you're reading this on were both built mostly by vaaski! A lesser known fact is that Apollo's user interface was originally going to be built in Electron by vaaski, but this ultimately didn't work out and I went for implementing an Avalonia user interface myself instead.

The process consisted of three different stages:
* First, we need to understand how the Launchpad handles firmware updates as we need to dump, modify, and then flash modified firmware onto it.
* Next, we need to reverse engineer the firmware and actually patch the button layout to match the traditional Drum Rack layout instead of using the XY Layout.
* Finally, we want to make the patching process as simple and smooth as possible for end users.

### Hacking the firmware

The first stage involved writing a command-line packer and unpacker for `.syx` firmware update files. While they do contain actual code, it's not possible to analyze it until it's unpacked into a raw hex dump. After the firmware file is modified, we'll need to later repack it in order to send our modifications to the Launchpad.

A part of the official packing process for the Launchpad Pro is actually open-sourced in [dvhdr's launchpad-pro repository](https://github.com/dvhdr/launchpad-pro/blob/master/tools/hextosyx.cpp). Comparing Launchpad Pro update files to Launchpad X update files, we could notice a lot of similarities! Understanding this code helped speed up the process of creating an unpacker significantly, and subsequently the packer as well as it's simply the reverse process that's happening.

The largest difference between the Pro and X though is that the Launchpad X additionally employs a checksum on the firmware data. It's most likely used to prevent errors and garbage firmware getting uploaded, but in our case it means the Launchpad will disregard any modifications we made. Brendonovich was the one to take a dive into the unpacked firmware and find the updating code itself, as the Launchpads can also be updated when booted to firmware in addition to the bootloader. Turns out the algorithm used is a simple [CRC32](https://github.com/mat1jaczyyy/LP-Firmware-Utility/blob/f90754c4e3179af842c7db35f3a95ceda3e25290/tools/common/common.cpp#L39) which we compute at packing time to ensure any firmware update we generate can be accepted by the Launchpad X.

### Patching the button layout

The most essential three patches that needed to happen were the following: convert button presses from XY to DR before sending them to the computer, convert side button presses from CCs to notes before sending them to the computer, and convert LED messages from DR to XY before rendering them on the LEDs. While I had lots of prior experience with x64 assembly, this was my first time fiddling with ARM instructions and I first had to spend some time adjusting and learning the language.

After writing and injecting the patches to the right place (which includes finding the places by understanding the symbol-less code by reverse engineering), we also opted for a few extra changes to help discern patched firmware from stock firmware: we changed the name of the Programmer mode to spell just "Cover" mode, and changed its color to Red mimicking the Performance mode found on my [Launchpad Pro custom firmware](https://github.com/mat1jaczyyy/lpp-performance-cfw#performance-mode). We also wrote separate patches for mapping the top row to the E0-B0 range utilized by the Pro or the C7-G#7 range utilized by the S and MK2 Launchpads.

### Simplifying the experience

Had we not decided to create our own interface for installing these patches, the process would look something like this: you'd download a pre-patched `.syx` update file and load it into a Max-based Flash Tool similar to the one used for installing Pro custom firmware.

We decided against this for a few reasons: this first assumes users will have Max installed and readily available. Back in 2018 when the Max Flash Tool was designed, this made sense: Ableton Live 9 Suite with Max for Live was the only viable software in use for light-production. Everyone had been using this at the time, and it was reasonable to assume users would be able to simply download the flasher and flash in a few moments. Today with Apollo Studio being actively used, some users might not have easy access to Max and will have to download the entirety of it before performing a simple flash action. Additionally, Live 10 users might have a harder time finding their Max installation, as it's now bundled with Live instead of requiring a standalone Max installation.

vaaski and Brendonovich thus designed and created the [Launchpad Firmware Utility](https://fw.mat1jaczyyy.com/) website, which we've filled with patching options for the Launchpad X and Mini MK3 as well as enabled for simply updating the Launchpad Pro and MK2. Inspired by Components' updater, all it takes to get a firmware installed is to open a webpage and select what you want - there's no external flasher application you need to download, the browser will send the SysEx messages with the update directly to the standard bootloader MIDI port for the desired Launchpad.

### Publishing our work

For such a simple change, the work that's built up around it seems unreal and massive. Having finished everything including the promotional video on a Sunday night, we decided to let it rest until Monday in case some imperfection surfaces, and went to bed expecting a special release day. An analogy: for our dear guests, we decided to prepare a roast duck for dinner. Not only we picked the most premium quality and expensive meat, we spent multiple days carefully preparing it and perfecting it, serving it to the guests by chopping to small pieces like you would for children to eat and enjoy carefree.

...instead, when we woke up, we've had quite a rough awakening. Immediately we've learned that Novation have released Legacy mode, which is an official update that does pretty much what we've done: enables carefree Drum Rack layout and backwards compatibility, while additionally retaining Programmer mode's default functionality. All the work we've built up during the last two months, culminated in it becoming utterly useless, as the new update was available similarly via Components. Another analogy: we not only got off on the wrong foot that morning, we got up on the wrong hand, fell on our head and had to be rushed to hospital. Keep in mind we've transitioned from the previous analogy to this one.

To say the least, while we're sorry to see our work become obsoleted without a chance to show how much effort and care went into it, we're happy an official solution exists, rather than people running hacked unofficial firmware on their brand new devices. It'll for sure be better in the long term as well, as further updates won't require recreating the patches, as well as better marketing the update to end users. We've still made it available as an easy firmware updater though, without the patches (as there's no need for them anymore).

## Launchpad Pro MK3

## Innovating Apollo Studio further

1.4.0 introduced a new device called Loop: its purpose being repeating incoming signals. The most important use case for this is  making a non-Pattern effect repeatable over time, or creating an echo. Multi's received a Key mode which enables powerful parallel processing, and Copy has received a Pinch feature similar to that found on the Pattern device.

## Cover Showcase

Here are some of the best covers created by Apollo Studio users throughout the month: 

[![Jason Ross - IOU (Crystal Skies Remix)](http://img.youtube.com/vi/T4-qurdZ6yE/mqdefault.jpg)](http://www.youtube.com/watch?v=T4-qurdZ6yE "Jason Ross - IOU (Crystal Skies Remix)") [![Gareth Emery - Sanctuary (feat. Lucy Saunders) [William Black Remix]](http://img.youtube.com/vi/10Y41LpDaKo/mqdefault.jpg)](http://www.youtube.com/watch?v=10Y41LpDaKo "Gareth Emery - Sanctuary (feat. Lucy Saunders) [William Black Remix]")

## Special thanks to...

AlexayForest, Mikhail Trofimov, Ezra Selga, Gabe Walls, Tuchan and Xiao Meng for supporting Apollo Studio on Patreon throughout the months of December, January and February. If you like Apollo Studio and want to support our work, [become a patron today](https://www.patreon.com/mat1jaczyyy)!

Got any questions or comments? Direct them to the official [Apollo Studio Discord server](https://discord.gg/2ZSHYHA).
